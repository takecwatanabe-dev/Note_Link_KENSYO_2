<!doctype html><html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>NOTE LINK â€” v0.8S-FIX21</title>
<!-- FIX21: UVåº§æ¨™ã‚’A4å›ºå®šã‚µã‚¤ã‚ºåŸºæº–ã«å¤‰æ›´ï¼ˆæ ¹æœ¬åŸå› ã®ä¿®æ­£ï¼‰ -->
<style>
:root{
  --ink:#e6f1ff;--ink-dim:#9bd6e9;--bg:#0b1020;--panel:#101827;--accent:#3f78ff;
  --ok:#20e3c2;--muted:#2a3550;--shadow:0 10px 24px rgba(0,0,0,.45);
  --topbar-h:44px;--toolbar-left:56px;--toolbar-right:0px;
}
*{box-sizing:border-box}
html,body{
  height:100%;margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
  -webkit-user-select:none;user-select:none;overflow:hidden;
  overscroll-behavior: none;
  overscroll-behavior-x: contain;
  touch-action: none;
}

/* ===== Topbar ===== */
header.topbar{
  position:fixed;top:0;left:0;right:0;z-index:2000;height:var(--topbar-h);
  display:flex;align-items:center;gap:8px;padding:0 10px;font-size:12px;color:#fff;
  background:linear-gradient(0deg,rgba(42,84,255,.16),rgba(42,84,255,.16)),var(--accent);
  border-bottom:1px solid #ffffff26; white-space:nowrap; overflow:hidden;
  padding-top:env(safe-area-inset-top);
  box-shadow:0 3px 10px rgba(0,0,0,.35);
}
.topbar .brand{flex:0 0 auto;font-weight:800}
.topbar .rail-wrap{ position:relative; flex:1 1 auto; min-width:40px; }
.topbar .rail-scroll{
  position:relative; flex:1 1 auto; min-width:40px;
  overflow-x:auto; overflow-y:hidden; display:flex; align-items:center; gap:8px;
  white-space:nowrap; -webkit-overflow-scrolling:touch;
  cursor:grab; user-select:none; -webkit-user-select:none;
  touch-action: pan-x;
}
.topbar .rail-scroll.dragging{ cursor:grabbing }
.topbar .right-fixed{flex:0 0 auto;display:flex;align-items:center;gap:8px}
.topbar .btn{height:28px;padding:0 10px;border-radius:10px;background:#ffffff33;
  border:1px solid #ffffff38;color:#fff;display:inline-flex;align-items:center}
.topbar .btn:active{transform:translateY(1px)}
.build{opacity:.8}

.rail-fade{position:absolute;top:0;bottom:0;width:28px;pointer-events:none;opacity:0;transition:opacity .2s}
.rail-fade.left{left:0;background:linear-gradient(to right,rgba(0,0,0,.35),rgba(0,0,0,0))}
.rail-fade.right{right:0;background:linear-gradient(to left,rgba(0,0,0,.35),rgba(0,0,0,0))}
.rail-wrap.can-overflow:not(.at-start) .rail-fade.left{opacity:.9}
.rail-wrap.can-overflow:not(.at-end) .rail-fade.right{opacity:.9}
.rail-hint{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  background:#0009;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;line-height:1.9;letter-spacing:.02em;
  pointer-events:none;opacity:0;transition:opacity .25s;box-shadow:0 4px 10px rgba(0,0,0,.25)
}
.rail-hint.show{opacity:1;animation:railPulse 1.6s ease-in-out 2}
@keyframes railPulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.06)}}

/* ===== Layout ===== */
#wrap{position:relative;height:100%;padding-top:var(--topbar-h)}
#stage{position:absolute;inset:0;padding-left:var(--toolbar-left);padding-right:var(--toolbar-right);}
#viewport{position:absolute;inset:0;transform-origin:0 0;touch-action:none}
#paper,#guide,#paint{position:absolute;left:var(--toolbar-left);top:0;right:var(--toolbar-right);bottom:0}
#paper,#guide{z-index:100;pointer-events:none}
#paint{z-index:120;touch-action:none;-webkit-touch-callout:none}

/* ===== Sidebar / Tools ===== */
.sidebar{
  position:fixed;z-index:1500;left:0;top:var(--topbar-h);bottom:0;width:56px;
  display:flex;flex-direction:column;align-items:center;background:rgba(0,0,0,.86);
  box-shadow:0 0 0 1px var(--muted) inset; transition:width .18s;
}
body.tb-right .sidebar{left:auto; right:0;}
.sidebar .rail{width:100%;padding:6px;display:flex;flex-direction:column;gap:8px}
.tool{display:grid;place-items:center;width:100%;height:36px;border-radius:10px;cursor:pointer;
  background:rgba(22,26,38,.75);border:1px solid rgba(50,60,100,.6);
  outline:1px solid rgba(79,124,255,.35);box-shadow:0 0 0 2px rgba(0,0,0,.12)}
.tool:hover{outline:1px solid rgba(79,124,255,.5)}
.tool.active{outline:1px solid var(--ok)}
.tool svg{width:18px;height:18px;stroke:var(--ink);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

body.tb-collapsed{ --toolbar-left:0px; --toolbar-right:0px; }
body.tb-collapsed .sidebar{ display:none }

.tb-handle{
  position:fixed;z-index:1600;top:calc(var(--topbar-h) + 8px);left:8px;
  width:36px;height:36px;border-radius:10px;display:none;place-items:center;
  background:#0b1020;color:#fff;border:1px solid #ffffff2e;box-shadow:0 4px 10px rgba(0,0,0,.35);
  touch-action:none;user-select:none;-webkit-user-select:none
}
body.tb-collapsed .tb-handle{ display:grid }
.tb-handle svg{width:18px;height:18px;stroke:#e6f1ff;fill:none;stroke-width:2}

/* ===== Panel / Text ===== */
.panel{position:absolute;z-index:1400;left:70px;top:calc(var(--topbar-h) + 10px);
  min-width:280px;max-width:320px;padding:8px 12px 10px;border-radius:14px;color:var(--ink);
  background:var(--panel);border:1px solid #ffffff24;box-shadow:var(--shadow);
  display:none;user-select:none;max-height:calc(100vh - var(--topbar-h) - 24px);overflow:auto}
.panel.show{display:block}
.panel .handle{position:sticky;top:0;display:flex;align-items:center;gap:8px;padding:8px 12px;
  margin:-8px -12px 8px;background:var(--panel);border-bottom:1px solid #ffffff20;border-radius:14px 14px 0 0;cursor:grab;touch-action:none}
#panelTool{flex:1;font-weight:600;font-size:14px;text-align:left}
.panel .close{margin-left:auto;height:26px;padding:0 10px;border-radius:8px;border:1px solid #ffffff2e;background:#ffffff14;color:#fff;font-size:14px}

.text-layer{position:absolute;left:var(--toolbar-left);top:0;right:var(--toolbar-right);bottom:0;z-index:130;pointer-events:none}
.note-text{position:absolute;min-width:64px;min-height:28px;padding:6px 8px;color:#111;background:transparent;
  outline:1px dashed #ffffff40;border-radius:6px;pointer-events:auto;
  -webkit-user-select:text; user-select:text; caret-color:auto}
.note-text[contenteditable="true"]:focus{outline:2px solid var(--ok)}
.note-text .del{position:absolute;right:-8px;top:-10px;font-size:11px;color:#fff;background:#0008;border:1px solid #fff3;border-radius:8px;padding:2px 6px;display:none}
.note-text:focus-within .del{display:block}

@media print{header.topbar,.sidebar,.panel{display:none!important}#stage{padding-left:0!important}body,html,#wrap{height:auto}}

#pageIndicator{min-width:48px;text-align:center}
#morePanel{position:fixed;right:10px;top:calc(var(--topbar-h) + 6px);z-index:3000;display:none;
  background:var(--panel);border:1px solid #ffffff24;border-radius:12px;box-shadow:var(--shadow);padding:8px}
#morePanel .btn{margin:4px 0;display:block;width:100%}
#debugInfo{
  position:fixed;top:60px;right:10px;background:rgba(0,0,0,0.8);color:#0f0;
  padding:10px;font-family:monospace;font-size:12px;z-index:10000;
  border:1px solid #0f0;border-radius:4px;pointer-events:none;
}
#debugInfo div{margin:2px 0;}
</style>
</head>
<body>
<header class="topbar" id="topbar">
  <div class="brand"><strong id="verText">NOTE LINK â€” v0.8S-FIX21</strong></div>

  <div class="rail-wrap" id="railWrap">
    <div class="rail-scroll" id="railScroll">
      <button class="btn" id="btnSetBg">èƒŒæ™¯</button>
      <button class="btn" id="btnLoad">èª­ã¿è¾¼ã¿</button>
      <button class="btn" id="btnSave">ä¿å­˜</button>
      <button class="btn" id="btnZoomOut">âˆ’</button>
      <button class="btn" id="btnZoomReset">100%</button>
      <button class="btn" id="btnZoomIn">ï¼‹</button>
      <button class="btn" id="btnUndo">UNDO</button>
      <button class="btn" id="btnRedo">REDO</button>
      <button class="btn" id="btnPrint">å°åˆ·</button>
      <button class="btn" id="btnPng">PNG</button>
      <button class="btn" id="btnShare">å…±æœ‰</button>
      <button class="btn" id="btnSpeech">ğŸ¤ éŸ³å£°</button>
      <button class="btn" id="btnRead">ğŸ”Š èª­ã¿ä¸Šã’</button>
      <span id="pageIndicator">1/1</span>
    </div>
    <div id="railHint" class="rail-hint" aria-hidden="true">â‡  ã‚¹ãƒ©ã‚¤ãƒ‰ â‡¢</div>
    <div class="rail-fade left"  aria-hidden="true"></div>
    <div class="rail-fade right" aria-hidden="true"></div>
  </div>

  <div class="right-fixed">
    <button class="btn" id="btnMore">â‹¯</button>
  </div>
</header>

<button id="tbHandle" class="tb-handle" aria-expanded="false" title="ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ é–‹ã/é–‰ã˜ã‚‹">
  <svg viewBox="0 0 24 24"><path d="M5 9 L12 16 L19 9 Z"/></svg>
</button>

<div id="morePanel">
  <button class="btn" id="btnPrev_m">â—€ å‰</button>
  <div style="text-align:center;color:#fff;margin:4px 0">ãƒšãƒ¼ã‚¸ <span id="pageIndicator_m">1/1</span></div>
  <button class="btn" id="btnNext_m">æ¬¡ â–¶</button>
  <hr style="border:none;border-top:1px solid #ffffff24;margin:6px 0">
  <button class="btn" id="btnAddPage_m">ï¼‹ãƒšãƒ¼ã‚¸</button>
  <button class="btn" id="btnSetBg_m">ç”»åƒã‚’èƒŒæ™¯ã«è¨­å®š</button>
</div>

<aside class="sidebar" id="sidebar">
  <div class="rail">
    <button class="tool" id="btnSidebarToggle" data-tool="toggle" title="ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®é–‹é–‰">
      <svg viewBox="0 0 24 24"><path d="M5 15 L12 8 L19 15 M19 15 L5 15"/></svg>
    </button>
    <button class="tool" data-tool="pen" title="ãƒšãƒ³">
      <svg viewBox="0 0 24 24"><path d="M3 21l4-1 12-12-3-3L4 17l-1 4zM14 6l3 3"/></svg>
    </button>
    <button class="tool" data-tool="marker" title="ãƒãƒ¼ã‚«ãƒ¼">
      <svg viewBox="0 0 24 24"><path d="M3 16l10-10 5 5-10 10-5 1 1-6zM13 6l5 5"/></svg>
    </button>
    <button class="tool" data-tool="eraser" title="æ¶ˆã—ã‚´ãƒ ">
      <svg viewBox="0 0 24 24"><path d="M3 15l8-8 6 6-6 6H7zM13 7l4 4"/></svg>
    </button>
    <button class="tool" data-tool="hand" title="é¸æŠ/ãƒ‘ãƒ³">
      <svg viewBox="0 0 24 24"><path d="M9 11V6a2 2 0 0 1 4 0v5M13 11V5a2 2 0 1 1 4 0v8M9 11a2 2 0 0 1 4 0v8l-2 2-4-4-2-6 2-1z"/></svg>
    </button>
    <button class="tool" data-tool="keyboard" title="ãƒ†ã‚­ã‚¹ãƒˆ">
      <svg viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="10" rx="2"></rect><path d="M7 10h10M5 13h14"/></svg>
    </button>
    <button class="tool" data-tool="settings" title="ãƒ„ãƒ¼ãƒ«è¨­å®šï¼ˆè¡¨ç¤º/éè¡¨ç¤ºï¼‰">
      <svg viewBox="0 0 24 24"><path d="M12 7.5a4.5 4.5 0 1 1 0 9 4.5 0 0 1 0-9zM4 13h2l1 2-1 2H4l-1-2 1-2zm14 0h2l1 2-1 2h-2l-1-2 1-2zM8 4h2l2 1 2-1h2l1 2-1 2h-2l-2-1-2 1H8L7 6l1-2z"/></svg>
    </button>
  </div>
</aside>

<div class="panel" id="panel">
  <div class="handle" id="panelHandle">
    <div id="panelTool">-</div>
    <button class="close" id="panelClose">â˜’</button>
  </div>
  <div class="row"><label>è‰²</label><input type="color" id="uiColor" value="#000000"></div>
  <div class="row" id="rowSize"><label>å¤ªã•</label><input type="range" min="1" max="60" value="4" id="uiSize"><span id="uiSizeVal">4px</span></div>
  <div class="row" id="rowAlpha"><label>ä¸é€æ˜åº¦</label><input type="range" min="10" max="100" value="50" id="uiAlpha"><span id="uiAlphaVal">50%</span></div>
  <div class="row" id="rowLineCap"><label>ç«¯ã®å½¢</label>
    <select id="uiCap"><option value="butt">â–¡ è§’</option><option value="round" selected>â— ä¸¸</option></select>
  </div>
  <div class="row" id="rowStraight"><label>ç›´ç·šãƒ¢ãƒ¼ãƒ‰</label>
    <label><input type="checkbox" id="uiStraight">ï¼ˆãƒ¢ãƒã‚¤ãƒ« / 15Â°åˆ»ã¿ï¼‰</label>
    <label><input type="checkbox" id="uiGridFirst">ã‚°ãƒªãƒƒãƒ‰å„ªå…ˆ</label>
  </div>
  <div class="row" id="rowGrid"><label>ã‚°ãƒªãƒƒãƒ‰</label>
    <label><input type="checkbox" id="uiGrid"> è¡¨ç¤º</label>
    <select id="uiGridStep"><option value="5">5mm</option><option value="10" selected>10mm</option><option value="15">15mm</option></select>
    <input type="color" id="uiGridColor" value="#b7bfd6"/>
  </div>
  <div class="row" id="rowPenExt">
    <label>ãƒšãƒ³æ‹¡å¼µ</label>
    <label><input type="checkbox" id="uiPalm"> ãƒ‘ãƒ¼ãƒ é™¤å¤–</label>
    <label><input type="checkbox" id="uiPressure" checked> åœ§åŠ›</label>
    <label><input type="checkbox" id="uiTilt" checked> å‚¾ã</label>
  </div>
  <div class="row" id="rowTextOps" style="display:none;gap:6px">
    <label>ãƒ†ã‚­ã‚¹ãƒˆ</label>
    <button id="btnTextAdd">è¿½åŠ </button>
    <button id="btnTextBold">å¤ªå­—</button>
    <button id="btnTextIt">æ–œä½“</button>
    <button id="btnTextDel">é¸æŠå‰Š</button>
    <button id="btnTextBoxDel">æ å‰Š</button>
  </div>
</div>

<div id="wrap"><div id="stage">
  <div id="viewport">
    <canvas id="paper"></canvas>
    <canvas id="guide"></canvas>
    <canvas id="paint"></canvas>
    <div class="text-layer" id="textLayer"></div>
  </div>
</div></div>

<div id="debugInfo">
  <div>Canvas: <span id="dbgCanvas">-</span></div>
  <div>Paper: <span id="dbgPaper">-</span></div>
  <div>Zoom: <span id="dbgZoom">-</span></div>
  <div>Pan: <span id="dbgPan">-</span></div>
  <div>Strokes: <span id="dbgStrokes">-</span></div>
</div>

<script>
/* ===== util & nodes ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const DPR=Math.max(1, self.devicePixelRatio||1);
const topbar=$('#topbar'), panel=$('#panel'), viewport=$('#viewport');
const cvPaper=$('#paper'), gPaper=cvPaper.getContext('2d');
const cvGuide=$('#guide'), gGuide=cvGuide.getContext('2d');
const cv=$('#paint'), ctx=cv.getContext('2d',{alpha:true});
const textLayer=$('#textLayer');
$('#verText').textContent='NOTE LINK â€” v0.8S-FIX21';

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°é–¢æ•°
function updateDebugInfo(){
  $('#dbgCanvas').textContent=`${W}x${H}`;
  $('#dbgPaper').textContent=`${Math.round(paperRect.w)}x${Math.round(paperRect.h)} @(${Math.round(paperRect.x)},${Math.round(paperRect.y)})`;
  $('#dbgZoom').textContent=`${(zoom*100).toFixed(0)}%`;
  $('#dbgPan').textContent=`(${Math.round(panX)},${Math.round(panY)})`;
  $('#dbgStrokes').textContent=`${Pages.cur().strokes.length}`;
}

// åº§æ¨™ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå®šè¦ï¼‰ã‚’æç”»ï¼ˆmmå˜ä½ã§A4ç”¨ç´™ä¸Šã«è¡¨ç¤ºï¼‰
function drawScale(){
  const c = ctx;
  c.save();
  c.globalCompositeOperation = 'source-over';
  c.strokeStyle = '#ff0000';
  c.fillStyle = '#ff0000';
  c.font = 'bold 14px monospace';
  c.lineWidth = 2;
  
  // A4ã‚µã‚¤ã‚ºï¼š210mm Ã— 297mm
  // 50mmé–“éš”ã§ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¡¨ç¤º
  
  // ç¸¦è»¸ï¼ˆå·¦ç«¯ã€ç”¨ç´™ã®å·¦ç«¯ã‹ã‚‰ï¼‰- 0mm, 50mm, 100mm...297mm
  for(let mm = 0; mm <= 297; mm += 50){
    const y = paperRect.y + (mm / 297) * paperRect.h;
    c.beginPath();
    c.moveTo(paperRect.x, y);
    c.lineTo(paperRect.x + 20, y);
    c.stroke();
    c.fillText(mm + 'mm', paperRect.x + 25, y + 5);
  }
  
  // æ¨ªè»¸ï¼ˆä¸Šç«¯ã€ç”¨ç´™ã®ä¸Šç«¯ã‹ã‚‰ï¼‰- 0mm, 50mm, 100mm...210mm
  for(let mm = 0; mm <= 210; mm += 50){
    const x = paperRect.x + (mm / 210) * paperRect.w;
    c.beginPath();
    c.moveTo(x, paperRect.y);
    c.lineTo(x, paperRect.y + 20);
    c.stroke();
    c.fillText(mm + 'mm', x + 3, paperRect.y + 35);
  }
  
  c.restore();
}

/* ===== layout & zoom ===== */
let zoom=1, panX=0, panY=0, W=0, H=0;
function applyBars(){ const h=Math.round(topbar.getBoundingClientRect().height)||44; document.documentElement.style.setProperty('--topbar-h',h+'px'); }
function updateViewportTransform(){ const tx=panX/zoom, ty=panY/zoom; viewport.style.transform=`scale(${zoom}) translate(${tx}px,${ty}px)`; }
function fitCanvases(){
  const vr=viewport.getBoundingClientRect();
  W=Math.max(1, Math.round(vr.width)); H=Math.max(1, Math.round(vr.height));
  for(const c of [cvPaper,cvGuide,cv]){ c.width=Math.round(W*DPR); c.height=Math.round(H*DPR); c.style.width=W+'px'; c.style.height=H+'px'; }
  layoutPaper(); drawPaper(); redrawAll();
}
addEventListener('resize',()=>{applyBars(); fitCanvases(); clampHandle(); updateRailOverflow();});
if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>{ applyBars(); fitCanvases(); clampHandle(); updateRailOverflow(); }); }
addEventListener('orientationchange', ()=>{ applyBars(); fitCanvases(); clampHandle(); updateRailOverflow(); });
applyBars();

/* ===== paper & grid ===== */
function mm2csspx(mm){return mm*96/25.4}
const A4={wmm:210,hmm:297}; 
// A4ã®å›ºå®šåŸºæº–ã‚µã‚¤ã‚ºï¼ˆUVåº§æ¨™è¨ˆç®—ç”¨ï¼‰
const A4_BASE_W = mm2csspx(210);  // ç´„793px
const A4_BASE_H = mm2csspx(297);  // ç´„1122px
let paperRect={x:0,y:0,w:0,h:0};
function isTouchDevice(){ return (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) || (navigator.maxTouchPoints>0); }
function layoutPaper(){
  const a4w=mm2csspx(A4.wmm), a4h=mm2csspx(A4.hmm);
  const vw=W, vh=H;
  if(!isTouchDevice()){
    let scale=1;
    if(a4w>vw || a4h>vh){ scale=Math.min(vw/a4w, vh/a4h); }
    const w=a4w*scale, h=a4h*scale, x=(vw-w)/2, y=(vh-h)/2;
    paperRect={x,y,w,h};
  }else{
    const sW=vw/a4w, w=a4w*sW, h=a4h*sW, x=0, y=(h<=vh)?(vh-h)/2:0;
    paperRect={x,y,w,h};
  }
}
let gridOn=false, gridStepMM=10, gridColor='#b7bfd6';
function drawPaper(){
  const g=gPaper; g.clearRect(0,0,cvPaper.width,cvPaper.height);
  g.fillStyle='#0b1020'; g.fillRect(0,0,cvPaper.width,cvPaper.height);
  const pg=Pages.cur(); g.fillStyle='#fff'; g.fillRect(paperRect.x*DPR,paperRect.y*DPR,paperRect.w*DPR,paperRect.h*DPR);
  if(pg.bg && pg.bg.img){ g.drawImage(pg.bg.img, paperRect.x*DPR, paperRect.y*DPR, paperRect.w*DPR, paperRect.h*DPR); }
  if(gridOn){
    const step = (gridStepMM / A4.hmm) * paperRect.h * DPR;
    g.save(); g.strokeStyle=gridColor+'88'; g.lineWidth=1*DPR; g.beginPath();
    for(let y=paperRect.y*DPR+step; y<=paperRect.y*DPR+paperRect.h*DPR-step; y+=step){ g.moveTo(paperRect.x*DPR,y); g.lineTo(paperRect.x*DPR+paperRect.w*DPR,y); }
    g.stroke(); g.restore();
  }
}

/* ===== pages ===== */
const Pages={ list:[{strokes:[],textsHTML:'',bg:null}], idx:0, cur(){ return this.list[this.idx]; } };
function setPage(i){ i=Math.max(0, Math.min(Pages.list.length-1, i)); Pages.cur().textsHTML=textLayer.innerHTML; Pages.idx=i; textLayer.innerHTML=Pages.cur().textsHTML||''; updatePageIndicator(); drawPaper(); redrawAll(); }
function updatePageIndicator(){ $('#pageIndicator').textContent=(Pages.idx+1)+'/'+Pages.list.length; $('#pageIndicator_m').textContent=(Pages.idx+1)+'/'+Pages.list.length; }
function addPage(){ const pos=Pages.idx+1; Pages.list.splice(pos,0,{strokes:[],textsHTML:'',bg:null}); setPage(pos); pushHistory(); }
function prevPage(){ setPage(Pages.idx-1); }
function nextPage(){ setPage(Pages.idx+1); }

/* ===== more panel ===== */
const morePanel=$('#morePanel'); const btnMore=$('#btnMore');
function toggleMore(on){ morePanel.style.display=on?'block':'none'; }
btnMore.onclick=()=>toggleMore(morePanel.style.display!=='block');
addEventListener('click',e=>{ if(!morePanel.contains(e.target) && e.target!==btnMore) toggleMore(false); });
$('#btnAddPage_m').onclick=()=>{ addPage(); toggleMore(false); };
$('#btnPrev_m').onclick=()=>{ prevPage(); toggleMore(false); };
$('#btnNext_m').onclick=()=>{ nextPage(); toggleMore(false); };
$('#btnSetBg_m').onclick=async()=>{ const file=await pickImage(); if(!file) return; const tmp=new Image(); tmp.src=URL.createObjectURL(file); await new Promise(r=>{ tmp.onload=r; tmp.onerror=r; }); const bg=fitImageToPaper(tmp); URL.revokeObjectURL(tmp.src); Pages.cur().bg=bg; drawPaper(); redrawAll(); pushHistory(); toggleMore(false); };

/* ===== tools & panel ===== */
let tool='pen';
const perTool={ pen:{color:'#000000',size:4,alpha:1,cap:'round',straight:false},
  marker:{color:'#ffff00',size:16,alpha:.5,cap:'butt',straight:false},
  eraser:{size:24}, hand:{}, keyboard:{} };
let color=perTool.pen.color, size=perTool.pen.size, alpha=1, cap='round';
let straightToggle=false, straightKey=false; let palmReject=false, pressureOn=true, tiltOn=true;

function saveToolState(k){const p=perTool[k]||(perTool[k]={}); p.color=color;p.size=size;p.alpha=alpha;p.cap=cap;p.straight=!!straightToggle;}
function loadToolState(k){const p=perTool[k]||{};color=p.color??color;size=p.size??size;alpha=p.alpha??alpha;cap=p.cap??cap;straightToggle=!!p.straight;}
function setActiveTool(t){
  saveToolState(tool); tool=t; loadToolState(t);
  $$('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
  $('#panelTool').textContent=t;
  $('#rowAlpha').style.display=(t==='marker')?'':'none';
  $('#rowLineCap').style.display=(t==='marker'||t==='pen')?'':'none';
  $('#rowStraight').style.display=(t==='pen'||t==='marker')?'':'none';
  $('#rowTextOps').style.display=(t==='keyboard')?'':'none';
  $('#rowSize').style.display=(t==='pen'||t==='marker'||t==='eraser')?'':'none';
  $('#rowPenExt').style.display=(t==='pen'||t==='marker')?'':'none';
  syncUI(); cv.style.cursor=(t==='hand')?'grab':(t==='keyboard')?'text':'crosshair';
}
$$('.tool').forEach(btn=>{
  if(btn.id==='btnSidebarToggle') return;
  btn.addEventListener('click', ()=>{
    const t=btn.dataset.tool;
    if(t==='settings'){
      const willShow=!panel.classList.contains('show');
      panel.classList.toggle('show', willShow);
      btn.classList.toggle('active', willShow);
      return;
    }
    setActiveTool(t);
  });
});
$('#btnSidebarToggle').onclick=()=>toggleToolbar('auto');

(()=>{const handle=$('#panelHandle');let dragging=false,sx=0,sy=0,ox=0,oy=0,id=0;
function down(e){ if(e.target.closest('#panelClose')) return; dragging=true; id=e.pointerId||1; try{panel.setPointerCapture(id)}catch{}; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault();}
function move(e){ if(!dragging) return; const nx=ox+(e.clientX-sx),ny=oy+(e.clientY-sy); panel.style.left=Math.max(56,nx)+'px'; const top=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--topbar-h'))+6; panel.style.top=Math.max(top,ny)+'px';}
function up(){ dragging=false; try{panel.releasePointerCapture(id)}catch{} }
handle.addEventListener('pointerdown',down,{passive:false});
panel.addEventListener('pointermove',move,{passive:false});
panel.addEventListener('pointerup',up,{passive:false});
panel.addEventListener('pointercancel',up,{passive:false});
$('#panelClose').addEventListener('click',()=>{ panel.classList.remove('show'); $$('.tool[data-tool="settings"]').forEach(b=>b.classList.remove('active')); });
})();
const ui={color:$('#uiColor'),size:$('#uiSize'),alpha:$('#uiAlpha'),sizeVal:$('#uiSizeVal'),alphaVal:$('#uiAlphaVal'),cap:$('#uiCap'),straight:$('#uiStraight'),gOn:$('#uiGrid'),gStep:$('#uiGridStep'),gColor:$('#uiGridColor'),palm:$('#uiPalm'),pressure:$('#uiPressure'),tilt:$('#uiTilt')};
function pxToMm(px){return px*25.4/96}
function syncUI(){ui.color.value=color;ui.size.value=size;ui.sizeVal.textContent=`${size}px (${pxToMm(size).toFixed(2)} mm)`;ui.alpha.value=Math.round((tool==='marker'?alpha:0.5)*100);ui.alphaVal.textContent=Math.round((tool==='marker'?alpha:0.5)*100)+'%';ui.cap.value=cap;ui.straight.checked=straightToggle;ui.gOn.checked=gridOn;ui.gStep.value=String(gridStepMM);ui.gColor.value=gridColor;ui.palm.checked=palmReject;ui.pressure.checked=pressureOn;ui.tilt.checked=tiltOn;}
function onPanelChange(){color=ui.color.value;size=+ui.size.value;alpha=(tool==='marker')?(+ui.alpha.value/100):alpha;ui.sizeVal.textContent=`${size}px (${pxToMm(size).toFixed(2)} mm)`;ui.alphaVal.textContent=Math.round(alpha*100)+'%';cap=ui.cap.value;straightToggle=ui.straight.checked;gridOn=ui.gOn.checked;gridStepMM=+ui.gStep.value;gridColor=ui.gColor.value;palmReject=ui.palm.checked;drawPaper();redrawAll();}
Object.values(ui).forEach(el=>el.addEventListener('input',onPanelChange));

/* ===== drawing (FIX11: ã‚¹ãƒ¯ã‚¤ãƒ—æ™‚ã®è‡ªå‹•ä¿å­˜) ===== */
function pointerToCanvas(e){ const r=cv.getBoundingClientRect(); return { x:(e.clientX - r.left)*(cv.width/r.width), y:(e.clientY - r.top)*(cv.height/r.height) }; }
// ã‚¨ãƒªã‚¢åˆ¤å®šã‚’å¤§å¹…ã«ç·©å’Œï¼ˆãƒãƒ¼ã‚¸ãƒ³200pxè¿½åŠ ï¼‰
function inPaperXY(x,y){ 
  const margin = 200;
  return x>=(paperRect.x-margin) && y>=(paperRect.y-margin) && 
         x<=(paperRect.x+paperRect.w+margin) && y<=(paperRect.y+paperRect.h+margin); 
}
let drawing=false, panning=false, start={x:0,y:0}, last={x:0,y:0};
let drawingPointerId=null;
let currentStroke=null;
let currentStrokeIndex=-1; // ç¾åœ¨ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®Pageså†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
let resetTimer=null;

// çŠ¶æ…‹ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
function forceResetDrawing(){
  drawing=false;
  panning=false;
  drawingPointerId=null;
  currentStroke=null;
  currentStrokeIndex=-1;
  clearGuide();
  cv.style.cursor=(tool==='hand')?'grab':(tool==='keyboard')?'text':'crosshair';
  if(resetTimer){ clearTimeout(resetTimer); resetTimer=null; }
}

// è‡ªå‹•ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ï¼ˆ1ç§’é–“æ“ä½œãŒãªã‘ã‚Œã°ãƒªã‚»ãƒƒãƒˆï¼‰
function scheduleReset(){
  if(resetTimer) clearTimeout(resetTimer);
  resetTimer=setTimeout(forceResetDrawing, 1000);
}

function setCtx(){ ctx.lineJoin='round'; ctx.lineCap=(tool==='marker'||tool==='pen')?cap:'round';
  if(tool==='eraser'){ ctx.globalCompositeOperation='destination-out'; ctx.strokeStyle='#000'; ctx.globalAlpha=1; }
  else if(tool==='marker'){ ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=color; ctx.globalAlpha=alpha; }
  else { ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=color; ctx.globalAlpha=1; }
  ctx.lineWidth=Math.max(1, Math.round(size*DPR));
}
function showGuide(sx,sy,ex,ey){ gGuide.clearRect(0,0,cvGuide.width,cvGuide.height);
  gGuide.save(); gGuide.setLineDash([6*DPR,6*DPR]); gGuide.lineWidth=Math.max(1,Math.round(size*DPR));
  gGuide.lineCap=cap; gGuide.strokeStyle='#7ec8ff'; gGuide.beginPath(); gGuide.moveTo(sx,sy); gGuide.lineTo(ex,ey); gGuide.stroke(); gGuide.restore(); }
function clearGuide(){ gGuide.clearRect(0,0,cvGuide.width,cvGuide.height); }
// UVåº§æ¨™ï¼šA4ã®å›ºå®šã‚µã‚¤ã‚ºã‚’åŸºæº–ã«æ­£è¦åŒ–ï¼ˆç”»é¢ã‚µã‚¤ã‚ºã«ä¾å­˜ã—ãªã„ï¼‰
function toUV(x,y){ return {u:(x-paperRect.x)/A4_BASE_W, v:(y-paperRect.y)/A4_BASE_H}; }
function fromUV(u,v){ return {x:paperRect.x + u*A4_BASE_W, y:paperRect.y + v*A4_BASE_H}; }

function onDown(e){
  if(tool==='hand'){ panning=true; cv.style.cursor='grabbing'; return; }
  
  // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é˜²æ­¢ï¼šç”»é¢ç«¯ã‹ã‚‰ã®å…¥åŠ›ã§ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’å®Œå…¨åœæ­¢
  e.preventDefault();
  e.stopPropagation();
  
  // ç”»é¢ç«¯ã‹ã‚‰ã®å…¥åŠ›ã®å ´åˆã€ã•ã‚‰ã«å¼·åŠ›ã«preventDefault
  const edgeMargin = 30; // å·¦å³ç«¯30pxã‚’ã‚¹ãƒ¯ã‚¤ãƒ—é˜²æ­¢ã‚¨ãƒªã‚¢ã«
  if(e.clientX < edgeMargin || e.clientX > window.innerWidth - edgeMargin){
    if(e.cancelable) e.preventDefault();
  }
  
  const p=pointerToCanvas(e);
  
  // æ—¢å­˜ã®æç”»ãŒã‚ã‚‹å ´åˆã¯ä¿å­˜ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿pushï¼‰
  if(drawing && currentStroke && currentStroke.pts.length>1 && currentStrokeIndex===-1){
    Pages.cur().strokes.push(currentStroke);
    pushHistory();
  }
  
  // å¸¸ã«æ–°ã—ã„æç”»ã‚’é–‹å§‹
  drawing=true; 
  drawingPointerId=e.pointerId; 
  start=last=p; 
  clearGuide();
  // sizeUã‚‚A4å›ºå®šã‚µã‚¤ã‚ºåŸºæº–ã«å¤‰æ›´
  currentStroke={tool:(tool==='marker'?'marker':tool==='eraser'?'eraser':'pen'),
    color:(tool==='marker'||tool==='pen')?color:'#000000', alpha:(tool==='marker')?alpha:1, cap:cap, sizeU:(size/A4_BASE_H), pts:[toUV(p.x,p.y)]};
  
  // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’å³åº§ã«Pages.cur().strokesã«è¿½åŠ ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—å¯¾ç­–ï¼‰
  Pages.cur().strokes.push(currentStroke);
  currentStrokeIndex = Pages.cur().strokes.length - 1;
  
  scheduleReset(); // è‡ªå‹•ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
}
function onMove(e){
  if(tool==='hand' && panning){ panX+=e.movementX||0; panY+=e.movementY||0; updateViewportTransform(); return; }
  if(!drawing) return; // pointerIdãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œ
  
  // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é˜²æ­¢ï¼šæç”»ä¸­ã¯å¸¸ã«preventDefault
  e.preventDefault();
  scheduleReset(); // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
  
  // pointerIdãŒé•ã£ã¦ã‚‚ã€æç”»ä¸­ãªã‚‰ç¶šã‘ã‚‹
  if(e.pointerId !== drawingPointerId){
    drawingPointerId = e.pointerId; // IDã‚’æ›´æ–°
  }
  
  const p=pointerToCanvas(e);
  const straight=(straightKey||$('#uiStraight').checked);
  if(straight){ showGuide(start.x,start.y,p.x,p.y); return; }
  const evs=(e.getCoalescedEvents&&e.getCoalescedEvents())||[e];
  setCtx(); ctx.beginPath(); ctx.moveTo(last.x,last.y);
  
  const ptsBefore = currentStroke.pts.length;
  // ã‚¨ãƒªã‚¢ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€å…¨ã¦ã®åº§æ¨™ã§æç”»å¯èƒ½ã«
  for(const ev of evs){ const q=pointerToCanvas(ev); ctx.lineTo(q.x,q.y); currentStroke.pts.push(toUV(q.x,q.y)); last=q; }
  ctx.stroke();
  
  // 10ãƒã‚¤ãƒ³ãƒˆã”ã¨ã«å±¥æ­´ã‚’ä¿å­˜ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—å¯¾ç­–ï¼‰
  if(currentStroke.pts.length - ptsBefore >= 10){
    pushHistory();
  }
}
function onUp(e){
  if(tool==='hand' && panning){ panning=false; cv.style.cursor='grab'; return; }
  if(!drawing || e.pointerId !== drawingPointerId){ 
    forceResetDrawing(); // çŠ¶æ…‹ãŒãŠã‹ã—ããªã£ã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
    return; 
  }
  const p=pointerToCanvas(e); const straight=(straightKey||$('#uiStraight').checked);
  if(straight){ setCtx(); ctx.beginPath(); ctx.moveTo(start.x,start.y); ctx.lineTo(p.x,p.y); ctx.stroke(); currentStroke.pts.push(toUV(p.x,p.y)); }
  
  // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã¯æ—¢ã«onDownã§Pages.cur().strokesã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã§é‡è¤‡ä¿å­˜ã—ãªã„
  // ãŸã ã—ã€ãƒã‚¤ãƒ³ãƒˆãŒ1ã¤ã—ã‹ãªã„å ´åˆã¯å‰Šé™¤
  if(currentStroke && currentStroke.pts.length <= 1 && currentStrokeIndex !== -1){
    Pages.cur().strokes.splice(currentStrokeIndex, 1);
  }
  
  // æœ€çµ‚çš„ã«å±¥æ­´ã‚’ä¿å­˜
  pushHistory();
  forceResetDrawing(); // ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆ
}
function onCancel(e){
  forceResetDrawing(); // å¸¸ã«ãƒªã‚»ãƒƒãƒˆ
}
function onLeave(e){
  // ãƒšãƒ³ãŒç”»é¢ã‹ã‚‰å®Œå…¨ã«é›¢ã‚ŒãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
  if(e.pointerId === drawingPointerId){
    forceResetDrawing();
  }
}
cv.addEventListener('pointerdown',onDown,{passive:false});
cv.addEventListener('pointermove',onMove,{passive:false});
cv.addEventListener('pointerup',onUp,{passive:false});
cv.addEventListener('pointercancel',onCancel,{passive:false});
cv.addEventListener('pointerleave',onLeave,{passive:false}); // è¿½åŠ 
addEventListener('keydown',e=>{ if(e.key==='Shift') straightKey=true; });
addEventListener('keyup',e=>{ if(e.key==='Shift') straightKey=false; });

function redrawAll(){
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.save(); ctx.beginPath(); ctx.rect(paperRect.x,paperRect.y,paperRect.w,paperRect.h); ctx.clip();
  for(const st of Pages.cur().strokes){
    // ç·šã®å¤ªã•ã‚‚A4å›ºå®šã‚µã‚¤ã‚ºåŸºæº–ã«å¤‰æ›´
    const w=st.sizeU*A4_BASE_H; ctx.lineJoin='round'; ctx.lineCap=st.cap||'round';
    ctx.globalCompositeOperation=(st.tool==='eraser')?'destination-out':'source-over';
    ctx.globalAlpha=(st.tool==='marker')?(st.alpha??0.5):1.0;
    ctx.strokeStyle=(st.tool==='pen'||st.tool==='marker')?(st.color||'#000'):'#000';
    ctx.lineWidth=Math.max(1,Math.round(w));
    const p0=fromUV(st.pts[0].u,st.pts[0].v); ctx.beginPath(); ctx.moveTo(p0.x,p0.y);
    for(let i=1;i<st.pts.length;i++){ const pi=fromUV(st.pts[i].u,st.pts[i].v); ctx.lineTo(pi.x,pi.y); }
    ctx.stroke();
  }
  ctx.restore();
  drawScale(); // åº§æ¨™ã‚¹ã‚±ãƒ¼ãƒ«æç”»
  updateDebugInfo(); // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
}

/* ===== output/save/load ===== */
function flushText(){ Pages.cur().textsHTML = textLayer.innerHTML || ''; }
function composite(){ const out=document.createElement('canvas'); out.width=cv.width; out.height=cv.height; const o=out.getContext('2d');
  o.drawImage(cvPaper,0,0); o.drawImage(cv,0,0);
  const L=textLayer.getBoundingClientRect();
  [...textLayer.querySelectorAll('.note-text')].forEach(n=>{ const r=n.getBoundingClientRect(), x=((r.left-L.left)*(cv.width/(L.width||1))), y=((r.top-L.top)*(cv.height/(L.height||1)));
    o.fillStyle='#111'; o.font=(16*DPR)+'px system-ui'; o.fillText(n.textContent.replace(/å‰Šé™¤$/,''),x,y+16*DPR); });
  return out; }
$('#btnPng').onclick=()=>composite().toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='note-link.png';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),800)});
$('#btnPrint').onclick=()=>window.print();
$('#btnShare').onclick=()=>{composite().toBlob(async b=>{const f=new File([b],'note.png',{type:'image/png'});if(navigator.share&&navigator.canShare&&navigator.canShare({files:[f]})){try{await navigator.share({files:[f],title:'Note Link'})}catch(e){}}else{const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='note-link.png';a.click();setTimeout(()=>URL.revokeObjectURL(u),800)}})};

/* ===== éŸ³å£°æ©Ÿèƒ½ ===== */
let recognition = null;
let isListening = false;
let speechSynthesis = window.speechSynthesis;

// éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
function initSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return false;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.continuous = false;
  recognition.interimResults = false;
  
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    if (transcript.trim()) {
      // ãƒ†ã‚­ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
      if (tool === 'keyboard') {
        addTextFromSpeech(transcript);
      } else {
        // ãã‚Œä»¥å¤–ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã¦è¿½åŠ 
        setActiveTool('keyboard');
        setTimeout(() => addTextFromSpeech(transcript), 100);
      }
    }
    isListening = false;
    updateSpeechButton();
  };
  
  recognition.onerror = (e) => {
    console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', e.error);
    isListening = false;
    updateSpeechButton();
    if (e.error === 'no-speech') {
      alert('éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  };
  
  recognition.onend = () => {
    isListening = false;
    updateSpeechButton();
  };
  
  return true;
}

// éŸ³å£°èªè­˜é–‹å§‹/åœæ­¢
function toggleSpeechRecognition() {
  if (!recognition) {
    if (!initSpeechRecognition()) {
      alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
      return;
    }
  }
  
  if (isListening) {
    recognition.stop();
    isListening = false;
  } else {
    try {
      recognition.start();
      isListening = true;
    } catch (e) {
      console.error('éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼:', e);
      isListening = false;
    }
  }
  updateSpeechButton();
}

// éŸ³å£°èªè­˜ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
function updateSpeechButton() {
  const btn = $('#btnSpeech');
  if (btn) {
    btn.textContent = isListening ? 'â¹ åœæ­¢' : 'ğŸ¤ éŸ³å£°';
    btn.style.background = isListening ? '#ff4444' : '';
  }
}

// éŸ³å£°ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
function addTextFromSpeech(text) {
  flushText();
  const textEl = document.createElement('div');
  textEl.className = 'note-text';
  textEl.contentEditable = 'true';
  textEl.textContent = text;
  
  // ç”¨ç´™ã®ä¸­å¤®ä»˜è¿‘ã«é…ç½®
  const centerX = paperRect.x + paperRect.w / 2;
  const centerY = paperRect.y + paperRect.h / 2;
  textEl.style.left = centerX + 'px';
  textEl.style.top = centerY + 'px';
  
  textLayer.appendChild(textEl);
  textEl.focus();
  
  // ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³
  const delBtn = document.createElement('span');
  delBtn.className = 'del';
  delBtn.textContent = 'å‰Šé™¤';
  delBtn.onclick = (e) => {
    e.stopPropagation();
    textEl.remove();
    flushText();
    pushHistory();
  };
  textEl.appendChild(delBtn);
  
  flushText();
  pushHistory();
}

// ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’
function readText() {
  if (!speechSynthesis) {
    alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
    return;
  }
  
  // æ—¢ã«èª­ã¿ä¸Šã’ä¸­ã®å ´åˆã¯åœæ­¢
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
    $('#btnRead').textContent = 'ğŸ”Š èª­ã¿ä¸Šã’';
    return;
  }
  
  // ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’å–å¾—
  const textElements = textLayer.querySelectorAll('.note-text');
  let allText = '';
  
  textElements.forEach(el => {
    const text = el.textContent.replace(/å‰Šé™¤$/, '').trim();
    if (text) {
      allText += text + 'ã€‚';
    }
  });
  
  if (!allText.trim()) {
    alert('èª­ã¿ä¸Šã’ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
    return;
  }
  
  const utterance = new SpeechSynthesisUtterance(allText);
  utterance.lang = 'ja-JP';
  utterance.rate = 1.0;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;
  
  utterance.onstart = () => {
    $('#btnRead').textContent = 'â¹ åœæ­¢';
  };
  
  utterance.onend = () => {
    $('#btnRead').textContent = 'ğŸ”Š èª­ã¿ä¸Šã’';
  };
  
  utterance.onerror = (e) => {
    console.error('èª­ã¿ä¸Šã’ã‚¨ãƒ©ãƒ¼:', e);
    $('#btnRead').textContent = 'ğŸ”Š èª­ã¿ä¸Šã’';
  };
  
  speechSynthesis.speak(utterance);
}

// ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
$('#btnSpeech').onclick = toggleSpeechRecognition;
$('#btnRead').onclick = readText;

// åˆæœŸåŒ–
initSpeechRecognition();

let fileHandle=null;
function exportJSON(){ flushText(); return JSON.stringify({ v:'v0.8S-FIX21',
  pages: Pages.list.map(pg=>({strokes:pg.strokes||[],textsHTML:pg.textsHTML||'', bg:pg.bg && pg.bg.dataURL ? {dataURL:pg.bg.dataURL}:null})),
  idx: Pages.idx, grid:{on:gridOn,stepMM:gridStepMM,color:gridColor} }); }
async function doSave(){ const blob=new Blob([exportJSON()],{type:'application/json'});
  try{ if('showSaveFilePicker' in window){ if(!fileHandle){ fileHandle=await window.showSaveFilePicker({suggestedName:'note-link.json',types:[{description:'Note Link JSON',accept:{'application/json':['.json']}}]}); }
      const w=await fileHandle.createWritable(); await w.write(blob); await w.close();
    }else{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='note-link.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800); }
  }catch(e){} }
async function doLoad(){ try{
    let f=null;
    if('showOpenFilePicker' in window){ const [h]=await window.showOpenFilePicker({types:[{description:'Note Link JSON',accept:{'application/json':['.json']}}]}); f=await h.getFile(); fileHandle=h; }
    else{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
      f=await new Promise(res=>{ inp.onchange=()=>res(inp.files[0]); inp.click(); });
    }
    const txt=await f.text(); const data=JSON.parse(txt);
    Pages.list=(data.pages||[]).map(pg=>{ const entry={strokes:pg.strokes||[],textsHTML:pg.textsHTML||'',bg:null};
      if(pg.bg && pg.bg.dataURL){ const img=new Image(); img.src=pg.bg.dataURL; entry.bg={dataURL:pg.bg.dataURL,img}; } return entry; });
    if(!Pages.list.length) Pages.list=[{strokes:[],textsHTML:'',bg:null}];
    Pages.idx=Math.max(0,Math.min(Pages.list.length-1,data.idx||0));
    gridOn=!!data.grid?.on; gridStepMM=data.grid?.stepMM||10; gridColor=data.grid?.color||'#b7bfd6';
    textLayer.innerHTML=Pages.cur().textsHTML||''; updatePageIndicator(); drawPaper(); redrawAll(); pushHistory();
  }catch(e){} }
$('#btnSave').onclick=doSave; $('#btnLoad').onclick=doLoad;

async function pickImage(){
  try{
    if('showOpenFilePicker' in window){
      const [h]=await window.showOpenFilePicker({types:[{description:'JPEG/PNG',accept:{'image/*':['.jpg','.jpeg','.png']}}]});
      return await h.getFile();
    }else{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='image/jpeg,image/png';
      return await new Promise(res=>{ inp.onchange=()=>res(inp.files[0]); inp.click(); });
    }
  }catch(e){ return null; }
}
function fitImageToPaper(img){
  const off=document.createElement('canvas'); off.width=Math.round(paperRect.w*DPR); off.height=Math.round(paperRect.h*DPR);
  const o=off.getContext('2d'); const sc=Math.min(off.width/img.naturalWidth, off.height/img.naturalHeight);
  const w=img.naturalWidth*sc, h=img.naturalHeight*sc, x=(off.width-w)/2, y=(off.height-h)/2;
  o.fillStyle='#fff'; o.fillRect(0,0,off.width,off.height); o.drawImage(img,x,y,w,h);
  const dataURL=off.toDataURL('image/jpeg',0.9); const fitted=new Image(); fitted.src=dataURL;
  return {dataURL, img:fitted};
}
async function setBackground(){ const file=await pickImage(); if(!file) return;
  const tmp=new Image(); tmp.src=URL.createObjectURL(file);
  await new Promise(r=>{ tmp.onload=r; tmp.onerror=r; });
  const bg=fitImageToPaper(tmp); URL.revokeObjectURL(tmp.src);
  Pages.cur().bg=bg; drawPaper(); redrawAll(); pushHistory();
}
document.getElementById('btnSetBg').onclick=()=>setBackground();
document.getElementById('btnSetBg_m').onclick=()=>setBackground();

const hist=[], redoStack=[];
function snapshot(){ flushText(); return {pages:JSON.parse(JSON.stringify(Pages.list.map(p=>({strokes:p.strokes,textsHTML:p.textsHTML,bg:p.bg?{dataURL:p.bg.dataURL}:null})))), idx:Pages.idx, grid:{on:gridOn,stepMM:gridStepMM,color:gridColor}}; }

// localStorageè‡ªå‹•ä¿å­˜æ©Ÿèƒ½
function saveToLocalStorage(){
  try{
    const data = exportJSON();
    localStorage.setItem('notelink_autosave', data);
    localStorage.setItem('notelink_autosave_time', new Date().toISOString());
  }catch(e){
    console.warn('localStorageä¿å­˜å¤±æ•—:', e);
  }
}

// localStorageè‡ªå‹•èª­ã¿è¾¼ã¿æ©Ÿèƒ½
function loadFromLocalStorage(){
  try{
    const data = localStorage.getItem('notelink_autosave');
    if(!data) return false;
    
    const parsed = JSON.parse(data);
    Pages.list=(parsed.pages||[]).map(pg=>{ 
      const entry={strokes:pg.strokes||[],textsHTML:pg.textsHTML||'',bg:null};
      if(pg.bg && pg.bg.dataURL){ const img=new Image(); img.src=pg.bg.dataURL; entry.bg={dataURL:pg.bg.dataURL,img}; } 
      return entry; 
    });
    if(!Pages.list.length) Pages.list=[{strokes:[],textsHTML:'',bg:null}];
    Pages.idx=Math.max(0,Math.min(Pages.list.length-1,parsed.idx||0));
    gridOn=!!parsed.grid?.on; gridStepMM=parsed.grid?.stepMM||10; gridColor=parsed.grid?.color||'#b7bfd6';
    textLayer.innerHTML=Pages.cur().textsHTML||''; 
    updatePageIndicator();
    // drawPaper()ã¨redrawAll()ã¯boot()ã§å¾Œã‹ã‚‰å‘¼ã¶ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨ˆç®—å¾Œï¼‰
    return true;
  }catch(e){
    console.warn('localStorageèª­ã¿è¾¼ã¿å¤±æ•—:', e);
    return false;
  }
}

function pushHistory(){ 
  hist.push(snapshot()); 
  if(hist.length>40) hist.shift(); 
  redoStack.length=0; 
  updatePageIndicator(); 
  saveToLocalStorage(); // å±¥æ­´æ›´æ–°æ™‚ã«localStorageã«ã‚‚è‡ªå‹•ä¿å­˜
}

function restoreSnap(s){
  Pages.list=s.pages.map(pg=>{ const entry={strokes:pg.strokes||[],textsHTML:pg.textsHTML||'',bg:null}; if(pg.bg&&pg.bg.dataURL){ const img=new Image(); img.src=pg.bg.dataURL; entry.bg={dataURL:pg.bg.dataURL,img}; } return entry; });
  Pages.idx=Math.max(0,Math.min(Pages.list.length-1,s.idx||0)); textLayer.innerHTML=Pages.cur().textsHTML||''; updatePageIndicator(); drawPaper(); redrawAll();
}
$('#btnUndo').onclick=()=>{ if(!hist.length) return; const cur=snapshot(); const prev=hist.pop(); redoStack.push(cur); restoreSnap(prev); saveToLocalStorage(); };
$('#btnRedo').onclick=()=>{ const nxt=redoStack.pop(); if(!nxt) return; hist.push(snapshot()); restoreSnap(nxt); saveToLocalStorage(); };

const rail = document.getElementById('railScroll');
const railWrap = document.getElementById('railWrap');
function updateRailOverflow(){
  const can = rail.scrollWidth > rail.clientWidth + 1;
  railWrap.classList.toggle('can-overflow', can);
  railWrap.classList.toggle('at-start', rail.scrollLeft<=0);
  railWrap.classList.toggle('at-end', Math.ceil(rail.scrollLeft+rail.clientWidth) >= rail.scrollWidth);
}
rail.addEventListener('scroll', updateRailOverflow);
setTimeout(updateRailOverflow, 0);

rail.addEventListener('wheel',(e)=>{ const useY=Math.abs(e.deltaY)>=Math.abs(e.deltaX); const d=useY?e.deltaY:e.deltaX;
  if(d!==0){ rail.scrollLeft+=d; e.preventDefault(); } },{passive:false});
let railDown=false, railDrag=false, railStartX=0, railStartLeft=0, railPointerId=null;
const DRAG_THRESHOLD=8;
let railJustDragged=false, railJustDraggedTimer=0;
rail.addEventListener('pointerdown',(e)=>{
  if(e.button!==0 && e.pointerType==='mouse') return;
  railDown=true; railDrag=false; railStartX=e.clientX; railStartLeft=rail.scrollLeft; railPointerId=e.pointerId;
});
rail.addEventListener('pointermove',(e)=>{
  if(!railDown) return;
  const dx=e.clientX-railStartX;
  if(!railDrag && Math.abs(dx)>DRAG_THRESHOLD){ railDrag=true; rail.classList.add('dragging'); rail.setPointerCapture?.(railPointerId); }
  if(railDrag){ rail.scrollLeft=railStartLeft-dx; e.preventDefault(); }
},{passive:false});
function railEnd(e){
  if(!railDown) return;
  if(railDrag){
    e.preventDefault();
    railJustDragged=true;
    clearTimeout(railJustDraggedTimer);
    railJustDraggedTimer=setTimeout(()=>{ railJustDragged=false; },120);
  }
  railDown=false; railDrag=false; rail.classList.remove('dragging'); try{ rail.releasePointerCapture?.(railPointerId);}catch{} railPointerId=null;
}
rail.addEventListener('pointerup',railEnd,{passive:false});
rail.addEventListener('pointercancel',railEnd,{passive:false});
rail.addEventListener('pointerleave',railEnd,{passive:true});
rail.addEventListener('click',(e)=>{
  if(railJustDragged){ e.stopPropagation(); e.preventDefault(); railJustDragged=false; }
}, true);

const bodyEl=document.body, tbHandle=document.getElementById('tbHandle');
function isCollapsed(){ return bodyEl.classList.contains('tb-collapsed'); }
function isRightDock(){ return bodyEl.classList.contains('tb-right'); }
function updateHandleIcon(){ const open=!isCollapsed(); tbHandle.innerHTML=open
  ? '<svg viewBox="0 0 24 24"><path d="M5 15 L12 8 L19 15 Z"/></svg>'
  : '<svg viewBox="0 0 24 24"><path d="M5 9 L12 16 L19 9 Z"/></svg>'; }
function applyHandleX(px){ const x=Math.max(4, Math.min(Math.max(4,innerWidth-40), px)); tbHandle.style.left=x+'px'; }
function savedHandleX(side){ try{ const k='tbHandleX_'+(side|| (isRightDock()?'R':'L')); const v=localStorage.getItem(k); return (v==null? (side==='R'? innerWidth-44 : 8) : parseInt(v,10)||8); }catch{ return 8; } }
function saveHandleX(px){ try{ const k='tbHandleX_'+(isRightDock()?'R':'L'); localStorage.setItem(k, String(px)); }catch{} }
function setDock(side){ if(side==='right'){ bodyEl.classList.add('tb-right'); document.documentElement.style.setProperty('--toolbar-left','0px'); document.documentElement.style.setProperty('--toolbar-right','56px'); }
  else { bodyEl.classList.remove('tb-right'); document.documentElement.style.setProperty('--toolbar-left','56px'); document.documentElement.style.setProperty('--toolbar-right','0px'); } }
function handleCenterX(){ const x=parseInt(tbHandle.style.left||'8',10)||8; return x+18; }

function toggleToolbar(mode='auto'){
  const vRect0 = viewport.getBoundingClientRect();
  const anchorXscreen = vRect0.left + (paperRect.x + paperRect.w/2)*zoom + panX;
  const anchorYscreen = vRect0.top  + (paperRect.y + paperRect.h/2)*zoom + panY;

  const willCollapse=(mode==='auto')?!isCollapsed():(mode==='collapse');

  if(!willCollapse && isCollapsed()){
    const side = (handleCenterX() > innerWidth/2) ? 'right' : 'left';
    setDock(side);
  }
  if(willCollapse){ bodyEl.classList.add('tb-collapsed'); tbHandle.setAttribute('aria-expanded','false'); }
  else            { bodyEl.classList.remove('tb-collapsed'); tbHandle.setAttribute('aria-expanded','true'); }

  updateHandleIcon();
  applyBars(); fitCanvases(); clampHandle();

  const vRect1 = viewport.getBoundingClientRect();
  const nowXscreen = vRect1.left + (paperRect.x + paperRect.w/2)*zoom + panX;
  const nowYscreen = vRect1.top  + (paperRect.y + paperRect.h/2)*zoom + panY;

  panX += (anchorXscreen - nowXscreen);
  panY += (anchorYscreen - nowYscreen);
  updateViewportTransform();
}

tbHandle.addEventListener('click', e=>{
  if(justDragged){ justDragged=false; return; }
  toggleToolbar('auto');
});
let draggingHandle=false, handleMoved=false, hx=0, startX=0, saveTick=0, justDragged=false;
tbHandle.addEventListener('pointerdown', e=>{
  draggingHandle=true; handleMoved=false; startX=e.clientX; hx=parseInt(tbHandle.style.left||(savedHandleX(isRightDock()?'R':'L')),10)||8;
  tbHandle.setPointerCapture?.(e.pointerId); e.preventDefault();
},{passive:false});
tbHandle.addEventListener('pointermove', e=>{
  if(!draggingHandle) return;
  const dx=e.clientX-startX;
  if(Math.abs(dx)>0){ handleMoved=true; }
  const nx=Math.max(4, Math.min(Math.max(4,innerWidth-40), hx+dx));
  tbHandle.style.left=nx+'px';
  const now=performance.now(); if(now-saveTick>30){ saveHandleX(nx); saveTick=now; }
  e.preventDefault();
},{passive:false});
function endHandle(e){
  if(!draggingHandle) return;
  draggingHandle=false;
  const nx=parseInt(tbHandle.style.left||(savedHandleX(isRightDock()?'R':'L')),10)||8;
  saveHandleX(nx);
  if(handleMoved){ justDragged=true; setTimeout(()=>{ justDragged=false; },0); e.preventDefault(); }
  try{tbHandle.releasePointerCapture?.(e.pointerId);}catch{}
}
tbHandle.addEventListener('pointerup', endHandle, {passive:false});
tbHandle.addEventListener('pointercancel', endHandle, {passive:false});
function clampHandle(){ const side=isRightDock()?'R':'L'; const x=parseInt(tbHandle.style.left||savedHandleX(side),10)||8; applyHandleX(x); }

function setZoom(z){ const z0=zoom, z1=Math.max(0.6,Math.min(3,z));
  const vrW=viewport.clientWidth, vrH=viewport.clientHeight; const Cx=vrW/2, Cy=vrH/2;
  const Ux=(Cx - panX)/z0, Uy=(Cy - panY)/z0; zoom=z1; panX = Cx - Ux*z1; panY = Cy - Uy*z1; updateViewportTransform();
  $('#btnZoomReset').textContent=Math.round(zoom*100)+'%'; }
$('#btnZoomIn').addEventListener('click', ()=>setZoom(zoom+0.1));
$('#btnZoomOut').addEventListener('click', ()=>setZoom(zoom-0.1));
$('#btnZoomReset').addEventListener('click', ()=>setZoom(1));

function boot(){
  const leftSaved = localStorage.getItem('tbHandleX_L');
  const rightSaved = localStorage.getItem('tbHandleX_R');
  setDock( rightSaved && (!leftSaved || parseInt(rightSaved,10) > innerWidth/2) ? 'right' : 'left' );
  
  // localStorageã‹ã‚‰è‡ªå‹•å¾©å…ƒã‚’è©¦ã¿ã‚‹
  const loaded = loadFromLocalStorage();
  if(loaded){
    console.log('å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
  }
  
  setActiveTool('pen');
  updateHandleIcon(); 
  applyHandleX(savedHandleX(isRightDock()?'R':'L'));
  panel.classList.remove('show'); 
  $$('.tool[data-tool="settings"]').forEach(b=>b.classList.remove('active'));
  updatePageIndicator();
  
  if(!loaded){
    pushHistory(); // æ–°è¦ã®å ´åˆã®ã¿åˆæœŸå±¥æ­´ã‚’ä½œæˆ
  }
  
  updateRailOverflow();
  
  // DOMã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå®Œå…¨ã«æº–å‚™ã§ãã‚‹ã¾ã§å¾…ã¤ï¼ˆ300mså¾Œã«æç”»ã€2æ®µéšã§ç¢ºå®Ÿã«ï¼‰
  setTimeout(() => {
    updateViewportTransform(); 
    fitCanvases();
    // ã•ã‚‰ã«50mså¾…ã£ã¦ã‚‚ã†ä¸€åº¦è¨ˆç®—ï¼ˆpaperRectã‚’ç¢ºå®Ÿã«è¨ˆç®—ï¼‰
    setTimeout(() => {
      layoutPaper(); // paperRectã‚’å†è¨ˆç®—
      drawPaper();
      redrawAll();
      console.log('æç”»å®Œäº†: paperRect=', paperRect);
    }, 50);
  }, 300);
}
boot();

/* ===== ã‚¹ãƒ¯ã‚¤ãƒ—æ™‚ã®è‡ªå‹•ä¿å­˜ï¼†å†æç”»ï¼ˆFIX20: å¼·åŒ–ç‰ˆï¼‰ ===== */
// ãƒšãƒ¼ã‚¸é›¢è„±å‰ã«ä¿å­˜
addEventListener('beforeunload', (e) => {
  saveToLocalStorage(); // å¸¸ã«ä¿å­˜
});

// ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã£ãŸã¨ãã‚‚ä¿å­˜ï¼ˆAndroidã®ã‚¹ãƒ¯ã‚¤ãƒ—å¯¾ç­–ï¼‰
addEventListener('visibilitychange', () => {
  if(document.hidden){
    saveToLocalStorage(); // å¸¸ã«ä¿å­˜
  } else {
    // ãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚ŒãŸã¨ãã€paperRectã‚’å†è¨ˆç®—ã—ã¦å†æç”»
    setTimeout(() => {
      console.log('visibilitychange: å†è¨ˆç®—é–‹å§‹');
      updateViewportTransform();
      fitCanvases();
      setTimeout(() => {
        layoutPaper(); // paperRectã‚’å†è¨ˆç®—
        drawPaper();
        redrawAll();
        console.log('visibilitychange: å†æç”»å®Œäº† paperRect=', paperRect);
      }, 50);
    }, 100);
  }
});

// ãƒšãƒ¼ã‚¸ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸã¨ãã‚‚ä¿å­˜
addEventListener('pagehide', () => {
  saveToLocalStorage(); // å¸¸ã«ä¿å­˜
});

// ãƒšãƒ¼ã‚¸ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤±ã£ãŸã¨ãã‚‚ä¿å­˜
addEventListener('blur', () => {
  saveToLocalStorage(); // å¸¸ã«ä¿å­˜
});
</script>
</body>
</html>

